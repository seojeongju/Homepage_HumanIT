<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>갤러리 관리 - 관리자</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet"/>
</head>
<body class="bg-gray-100">
    <div class="flex h-screen overflow-hidden">
        <!-- 모바일 오버레이 -->
        <div id="sidebarOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40 lg:hidden"></div>
        
        <!-- 사이드바 -->
        <aside id="sidebar" class="fixed lg:static inset-y-0 left-0 transform -translate-x-full lg:translate-x-0 w-64 bg-gradient-to-b from-blue-600 to-purple-600 text-white z-50 transition-transform duration-300 ease-in-out">
            <div class="p-6">
                <!-- 모바일 닫기 버튼 -->
                <div class="lg:hidden flex justify-end mb-4">
                    <button id="closeSidebar" class="text-white hover:bg-white/10 p-2 rounded-lg">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="flex items-center space-x-3 mb-8">
                    <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center">
                        <i class="fas fa-user-shield text-blue-600"></i>
                    </div>
                    <div>
                        <h2 class="font-bold">관리자</h2>
                        <p class="text-xs text-blue-200" id="adminUsername">-</p>
                    </div>
                </div>

                <nav class="space-y-2">
                    <a href="/admin/dashboard.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-white/10 transition">
                        <i class="fas fa-tachometer-alt w-5"></i>
                        <span>대시보드</span>
                    </a>
                    <a href="/admin/notice.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-white/10 transition">
                        <i class="fas fa-bullhorn w-5"></i>
                        <span>공지사항</span>
                    </a>
                    <a href="/admin/download.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-white/10 transition">
                        <i class="fas fa-download w-5"></i>
                        <span>자료실</span>
                    </a>
                    <a href="/admin/faq.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-white/10 transition">
                        <i class="fas fa-question-circle w-5"></i>
                        <span>FAQ</span>
                    </a>
                    <a href="/admin/gallery.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg bg-white/20 hover:bg-white/30 transition">
                        <i class="fas fa-images w-5"></i>
                        <span>갤러리</span>
                    </a>
                </nav>

                <div class="mt-8 pt-8 border-t border-white/20">
                    <button onclick="confirmLogout()" class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-red-500/20 transition w-full text-left">
                        <i class="fas fa-sign-out-alt w-5"></i>
                        <span>로그아웃</span>
                    </button>
                </div>
            </div>
        </aside>

        <!-- 메인 컨텐츠 -->
        <main class="flex-1 overflow-y-auto w-full">
            <!-- 헤더 -->
            <header class="bg-white shadow-sm sticky top-0 z-30">
                <div class="px-4 lg:px-8 py-4 lg:py-6">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4 flex-1">
                            <!-- 모바일 햄버거 메뉴 -->
                            <button id="openSidebar" class="lg:hidden text-gray-700 hover:text-blue-600 p-2">
                                <i class="fas fa-bars text-2xl"></i>
                            </button>
                            <div>
                                <h1 class="text-xl lg:text-2xl font-bold text-gray-900">갤러리 관리</h1>
                                <p class="text-gray-500 mt-1 text-sm lg:text-base hidden sm:block">이미지를 추가, 수정, 삭제할 수 있습니다</p>
                            </div>
                        </div>
                        <button onclick="showCreateModal()" class="px-3 lg:px-6 py-2 lg:py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition shadow-md hover:shadow-lg text-sm lg:text-base whitespace-nowrap">
                            <i class="fas fa-plus mr-1 lg:mr-2"></i>
                            <span class="hidden sm:inline">새 이미지 등록</span>
                            <span class="sm:hidden">추가</span>
                        </button>
                    </div>
                </div>
            </header>

            <!-- 갤러리 그리드 -->
            <div class="p-4 lg:p-8">
                <div id="galleryGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <div class="col-span-full text-center py-12">
                        <i class="fas fa-spinner fa-spin text-3xl text-gray-400 mb-4"></i>
                        <p class="text-gray-500">로딩 중...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 생성/수정 모달 -->
    <div id="galleryModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-8">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-900" id="modalTitle">새 이미지 등록</h2>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>

                <form id="galleryForm" class="space-y-6">
                    <input type="hidden" id="galleryId" />
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            제목 <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="title" required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="이미지 제목을 입력하세요" />
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">설명</label>
                        <textarea id="description" rows="3"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="이미지에 대한 설명을 입력하세요"></textarea>
                    </div>

                    <!-- 이미지 업로드 영역 -->
                    <div id="imageUploadArea" class="bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-6 hover:border-blue-400 transition cursor-pointer"
                         onclick="document.getElementById('imageInput').click()">
                        <input type="file" id="imageInput" class="hidden" accept="image/*" onchange="handleImageSelect(event)" />
                        <div class="text-center">
                            <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                            <p class="text-gray-600 mb-2">이미지를 드래그하거나 클릭하여 업로드하세요</p>
                            <p class="text-sm text-gray-400 mb-4">JPG, PNG, GIF, WebP (최대 10MB)</p>
                            <div id="imageUploadStatus" class="hidden mt-4">
                                <div class="flex items-center justify-center space-x-2">
                                    <i class="fas fa-spinner fa-spin text-blue-600"></i>
                                    <span class="text-blue-600">업로드 중...</span>
                                </div>
                            </div>
                            <div id="imageUploadPreview" class="hidden mt-4">
                                <img id="uploadPreviewImg" class="max-w-xs mx-auto rounded-lg shadow-md" />
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center space-x-4">
                        <div class="flex-1 border-t border-gray-300"></div>
                        <span class="text-sm text-gray-500">또는</span>
                        <div class="flex-1 border-t border-gray-300"></div>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            이미지 URL 직접 입력 <span class="text-red-500">*</span>
                        </label>
                        <input type="url" id="imageUrl" required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="https://example.com/image.jpg" />
                        <p class="text-xs text-gray-500 mt-1">이미지 업로드 또는 공개 URL을 입력하세요</p>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">썸네일 URL</label>
                        <input type="url" id="thumbnailUrl"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="https://example.com/thumbnail.jpg (선택사항)" />
                        <p class="text-xs text-gray-500 mt-1">비워두면 원본 이미지를 사용합니다</p>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                순서
                                <span class="text-xs text-gray-500">(낮은 숫자가 먼저 표시)</span>
                            </label>
                            <input type="number" id="orderNum" value="0" min="0"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">상태</label>
                            <select id="status"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="published">공개</option>
                                <option value="draft">비공개</option>
                            </select>
                        </div>
                    </div>

                    <!-- 미리보기 -->
                    <div id="imagePreview" class="hidden">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">미리보기</label>
                        <div class="border border-gray-300 rounded-lg p-4 bg-gray-50">
                            <img id="previewImg" src="" alt="Preview" class="max-w-full h-auto rounded-lg" />
                        </div>
                    </div>

                    <div class="flex space-x-4 pt-4">
                        <button type="submit" class="flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-semibold">
                            <i class="fas fa-save mr-2"></i>
                            저장
                        </button>
                        <button type="button" onclick="closeModal()" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition font-semibold">
                            취소
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 이미지 확대 모달 -->
    <div id="imageViewModal" class="hidden fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 p-4" onclick="closeImageView()">
        <div class="max-w-6xl w-full">
            <img id="viewModalImg" src="" alt="Full size" class="w-full h-auto rounded-lg" />
        </div>
    </div>

    <script src="/admin/js/common.js"></script>
    <script>
        let currentPage = 1;
        let currentEditId = null;
        let uploadedImageUrl = null;

        // 이미지 선택 처리
        async function handleImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // 이미지 타입 검증
            if (!file.type.startsWith('image/')) {
                showError('이미지 파일만 업로드할 수 있습니다.');
                return;
            }

            const uploadStatus = document.getElementById('imageUploadStatus');
            const uploadPreview = document.getElementById('imageUploadPreview');
            const uploadArea = document.getElementById('imageUploadArea');

            // 상태 초기화
            uploadPreview.classList.add('hidden');
            uploadStatus.classList.remove('hidden');
            uploadArea.classList.add('border-blue-400', 'bg-blue-50');

            try {
                // FormData 생성
                const formData = new FormData();
                formData.append('image', file);

                // API 호출
                const token = localStorage.getItem('adminToken');
                const response = await fetch('/api/upload/image', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.message);
                }

                // 업로드 성공
                uploadedImageUrl = result.data.imageUrl;
                document.getElementById('imageUrl').value = result.data.imageUrl;
                
                // 미리보기 표시
                const previewImg = document.getElementById('uploadPreviewImg');
                previewImg.src = result.data.imageUrl;
                uploadStatus.classList.add('hidden');
                uploadPreview.classList.remove('hidden');
                uploadArea.classList.remove('border-gray-300');
                uploadArea.classList.add('border-green-400', 'bg-green-50');

                // 하단 미리보기도 업데이트
                updatePreview();

            } catch (error) {
                console.error('이미지 업로드 실패:', error);
                showError(error.message || '이미지 업로드에 실패했습니다.');
                uploadStatus.classList.add('hidden');
                uploadArea.classList.remove('border-blue-400', 'bg-blue-50');
            }
        }

        // 모바일 사이드바 토글
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebarOverlay');
        const openBtn = document.getElementById('openSidebar');
        const closeBtn = document.getElementById('closeSidebar');

        function openSidebar() {
            sidebar.classList.remove('-translate-x-full');
            overlay.classList.remove('hidden');
        }

        function closeSidebar() {
            sidebar.classList.add('-translate-x-full');
            overlay.classList.add('hidden');
        }

        openBtn.addEventListener('click', openSidebar);
        closeBtn.addEventListener('click', closeSidebar);
        overlay.addEventListener('click', closeSidebar);

        // 페이지 로드 시
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            loadGalleries();
            
            document.getElementById('galleryForm').addEventListener('submit', handleSubmit);
            
            // 이미지 URL 입력 시 미리보기
            document.getElementById('imageUrl').addEventListener('input', updatePreview);
        });

        // 미리보기 업데이트
        function updatePreview() {
            const imageUrl = document.getElementById('imageUrl').value.trim();
            const preview = document.getElementById('imagePreview');
            const previewImg = document.getElementById('previewImg');
            
            if (imageUrl) {
                previewImg.src = imageUrl;
                preview.classList.remove('hidden');
            } else {
                preview.classList.add('hidden');
            }
        }

        // 갤러리 목록 로드
        async function loadGalleries(page = 1) {
            try {
                const response = await fetch(`/api/gallery?page=${page}&limit=50`);
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.message);
                }

                const { galleries, pagination } = result.data;
                currentPage = page;

                renderGalleryGrid(galleries, pagination);
            } catch (error) {
                console.error('갤러리 목록 로드 실패:', error);
                showError('갤러리 목록을 불러오는데 실패했습니다.');
            }
        }

        // 갤러리 그리드 렌더링
        function renderGalleryGrid(galleries, pagination) {
            const gridEl = document.getElementById('galleryGrid');

            if (!galleries || galleries.length === 0) {
                gridEl.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <i class="fas fa-images text-5xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500">등록된 이미지가 없습니다</p>
                        <button onclick="showCreateModal()" class="mt-4 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                            첫 이미지 등록하기
                        </button>
                    </div>
                `;
                return;
            }

            gridEl.innerHTML = galleries.map(gallery => `
                <div class="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-xl transition group">
                    <div class="relative aspect-square overflow-hidden bg-gray-100">
                        <img src="${escapeHtml(gallery.thumbnail_url || gallery.image_url)}" 
                             alt="${escapeHtml(gallery.title)}"
                             class="w-full h-full object-cover cursor-pointer group-hover:scale-110 transition duration-300"
                             onclick="viewFullImage('${escapeHtml(gallery.image_url)}')"
                             onerror="this.src='https://via.placeholder.com/400?text=Image+Not+Found'" />
                        ${gallery.status === 'draft' ? '<span class="absolute top-2 right-2 px-3 py-1 bg-yellow-500 text-white text-xs font-semibold rounded-full">비공개</span>' : ''}
                        <span class="absolute top-2 left-2 px-3 py-1 bg-black bg-opacity-50 text-white text-xs font-semibold rounded-full">
                            순서: ${gallery.order_num}
                        </span>
                    </div>
                    <div class="p-4">
                        <h3 class="font-bold text-gray-900 mb-2 truncate">${escapeHtml(gallery.title)}</h3>
                        ${gallery.description ? `<p class="text-sm text-gray-600 mb-3 line-clamp-2">${escapeHtml(gallery.description)}</p>` : ''}
                        <div class="flex items-center justify-between pt-3 border-t">
                            <span class="text-xs text-gray-500">${formatDate(gallery.created_at)}</span>
                            <div class="flex space-x-2">
                                <button onclick="editGallery(${gallery.id})" 
                                    class="px-3 py-1 text-blue-600 hover:bg-blue-50 rounded transition text-sm">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteGallery(${gallery.id})" 
                                    class="px-3 py-1 text-red-600 hover:bg-red-50 rounded transition text-sm">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // 이미지 확대 보기
        function viewFullImage(imageUrl) {
            document.getElementById('viewModalImg').src = imageUrl;
            document.getElementById('imageViewModal').classList.remove('hidden');
        }

        // 이미지 확대 모달 닫기
        function closeImageView() {
            document.getElementById('imageViewModal').classList.add('hidden');
        }

        // 생성 모달 표시
        function showCreateModal() {
            currentEditId = null;
            document.getElementById('modalTitle').textContent = '새 이미지 등록';
            document.getElementById('galleryForm').reset();
            document.getElementById('galleryId').value = '';
            document.getElementById('orderNum').value = '0';
            document.getElementById('imagePreview').classList.add('hidden');
            document.getElementById('galleryModal').classList.remove('hidden');
        }

        // 수정 모달 표시
        async function editGallery(id) {
            try {
                const response = await fetch(`/api/gallery/${id}`);
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.message);
                }

                const gallery = result.data;
                currentEditId = id;

                document.getElementById('modalTitle').textContent = '이미지 수정';
                document.getElementById('galleryId').value = id;
                document.getElementById('title').value = gallery.title;
                document.getElementById('description').value = gallery.description || '';
                document.getElementById('imageUrl').value = gallery.image_url;
                document.getElementById('thumbnailUrl').value = gallery.thumbnail_url || '';
                document.getElementById('orderNum').value = gallery.order_num || 0;
                document.getElementById('status').value = gallery.status || 'published';

                updatePreview();
                document.getElementById('galleryModal').classList.remove('hidden');
            } catch (error) {
                console.error('갤러리 로드 실패:', error);
                showError('갤러리 정보를 불러오는데 실패했습니다.');
            }
        }

        // 모달 닫기
        function closeModal() {
            document.getElementById('galleryModal').classList.add('hidden');
            document.getElementById('imagePreview').classList.add('hidden');
            currentEditId = null;
        }

        // 폼 제출 처리
        async function handleSubmit(e) {
            e.preventDefault();

            const title = document.getElementById('title').value.trim();
            const description = document.getElementById('description').value.trim();
            const imageUrl = document.getElementById('imageUrl').value.trim();
            const thumbnailUrl = document.getElementById('thumbnailUrl').value.trim();
            const orderNum = parseInt(document.getElementById('orderNum').value) || 0;
            const status = document.getElementById('status').value;

            if (!title || !imageUrl) {
                showError('제목과 이미지 URL은 필수입니다.');
                return;
            }

            try {
                const token = localStorage.getItem('adminToken');
                const method = currentEditId ? 'PUT' : 'POST';
                const url = currentEditId ? `/api/gallery/${currentEditId}` : '/api/gallery';

                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        title,
                        description,
                        image_url: imageUrl,
                        thumbnail_url: thumbnailUrl,
                        order_num: orderNum,
                        status
                    })
                });

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.message);
                }

                showSuccess(currentEditId ? '갤러리가 수정되었습니다.' : '갤러리가 등록되었습니다.');
                closeModal();
                loadGalleries(currentPage);
            } catch (error) {
                console.error('저장 실패:', error);
                showError(error.message || '저장에 실패했습니다.');
            }
        }

        // 갤러리 삭제
        async function deleteGallery(id) {
            if (!confirm('정말 이 이미지를 삭제하시겠습니까?')) {
                return;
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/gallery/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.message);
                }

                showSuccess('갤러리가 삭제되었습니다.');
                loadGalleries(currentPage);
            } catch (error) {
                console.error('삭제 실패:', error);
                showError('삭제에 실패했습니다.');
            }
        }

        // HTML 이스케이프
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 날짜 포맷
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        // 에러 메시지 표시
        function showError(message) {
            alert('❌ ' + message);
        }

        // 성공 메시지 표시
        function showSuccess(message) {
            alert('✅ ' + message);
        }
    </script>
</body>
</html>
